<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Mobius - Login</title>
    <link rel="icon" type="image/png" href="mobius-logo.png">
    <style>
        body {
            font-family: 'Century Gothic', 'Avenir', 'Segoe UI', 'Verdana', sans-serif;
            padding: 20px;
            max-width: 400px;
            margin: 80px auto;
            background: #e2dccd;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        h1 { margin: 0; font-size: 48px; }
        input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #8d7c64;
            border-radius: 1px;
            box-sizing: border-box;
            background: #f5eedd;
            font-family: 'Century Gothic', 'Avenir', 'Segoe UI', 'Verdana', sans-serif;
            margin-bottom: 10px;
        }
        button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: #8d7c64;
            color: white;
            border: none;
            border-radius: 1px;
            cursor: pointer;
            margin-top: 6px;
        }
        button:hover { background: #574d3e; }
        #error {
            color: #8B0000;
            margin-top: 10px;
            font-size: 14px;
        }
        /* Password field wrapper */
        .password-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .password-wrapper input {
            margin-bottom: 0;
            padding-right: 44px;
        }
        .eye-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
            width: auto;
            font-size: 18px;
            color: #8d7c64;
            line-height: 1;
        }
        .eye-btn:hover { color: #4a3728; background: none; }

        /* Fingerprint button */
        #fingerprintBtn {
            background: #f5eedd;
            color: #4a3728;
            border: 1px solid #8d7c64;
            margin-top: 10px;
            display: none;
        }
        #fingerprintBtn:hover { background: #d4c9b5; }
        .fingerprint-icon { font-size: 20px; margin-right: 8px; }
    </style>
</head>
<body>
    <div class="logo">
        <img src="mobius-logo.png" style="height: 75px;">
        <h1>Mobius</h1>
    </div>

    <label style="font-size:14px; color:#4a3728;">Username</label>
    <input type="text" id="username" placeholder="Enter username">

    <label style="font-size:14px; color:#4a3728;">Password</label>
    <div class="password-wrapper">
        <input type="password" id="password" placeholder="Enter password">
        <button class="eye-btn" type="button" onclick="togglePassword()" id="eyeBtn">üëÅ</button>
    </div>

    <button onclick="login()">Login</button>
    <button id="fingerprintBtn" onclick="fingerprintLogin()">
        <span class="fingerprint-icon">‚òù</span>Use Fingerprint
    </button>
    <div id="error"></div>

    <script>
        // ‚îÄ‚îÄ Password visibility toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function togglePassword() {
            const pwd = document.getElementById('password');
            const btn = document.getElementById('eyeBtn');
            if (pwd.type === 'password') {
                pwd.type = 'text';
                btn.textContent = 'üôà';
            } else {
                pwd.type = 'password';
                btn.textContent = 'üëÅ';
            }
        }

        // ‚îÄ‚îÄ Standard login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();

            if (data.userId) {
                localStorage.setItem('mobius_user_id', data.userId);
                localStorage.setItem('mobius_username', data.username);
                const expires = new Date(Date.now() + 10*365*24*60*60*1000).toUTCString();
                document.cookie = `mobius_user_id=${data.userId}; expires=${expires}; path=/`;
                document.cookie = `mobius_username=${data.username}; expires=${expires}; path=/`;
                // Offer fingerprint registration if supported and not yet registered
                if (window.PublicKeyCredential && !localStorage.getItem('mobius_passkey')) {
                    if (confirm('Register fingerprint for future logins?')) {
                        await registerFingerprint(data.userId, data.username);
                    }
                }
                window.location.href = '/';
            } else {
                document.getElementById('error').textContent = 'Invalid username or password.';
            }
        }

        // ‚îÄ‚îÄ Fingerprint registration (after successful login) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function registerFingerprint(userId, username) {
            try {
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);

                const credential = await navigator.credentials.create({
                    publicKey: {
                        challenge,
                        rp: { name: 'Mobius' },
                        user: {
                            id: new TextEncoder().encode(userId),
                            name: username,
                            displayName: username
                        },
                        pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
                        authenticatorSelection: {
                            authenticatorAttachment: 'platform',
                            userVerification: 'required'
                        },
                        timeout: 60000
                    }
                });

                // Store credential ID and user info locally
                localStorage.setItem('mobius_passkey', btoa(String.fromCharCode(...new Uint8Array(credential.rawId))));
                localStorage.setItem('mobius_passkey_user', JSON.stringify({ userId, username }));
                alert('Fingerprint registered! You can use it next time.');
            } catch (err) {
                console.log('Fingerprint registration cancelled or failed:', err.message);
            }
        }

        // ‚îÄ‚îÄ Fingerprint login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function fingerprintLogin() {
            try {
                const storedKey = localStorage.getItem('mobius_passkey');
                if (!storedKey) { alert('No fingerprint registered.'); return; }

                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);

                const credentialId = Uint8Array.from(atob(storedKey), c => c.charCodeAt(0));

                await navigator.credentials.get({
                    publicKey: {
                        challenge,
                        allowCredentials: [{ type: 'public-key', id: credentialId }],
                        userVerification: 'required',
                        timeout: 60000
                    }
                });

                // Fingerprint verified ‚Äî restore session
                const user = JSON.parse(localStorage.getItem('mobius_passkey_user'));
                localStorage.setItem('mobius_user_id', user.userId);
                localStorage.setItem('mobius_username', user.username);
                const expires = new Date(Date.now() + 10*365*24*60*60*1000).toUTCString();
                document.cookie = `mobius_user_id=${user.userId}; expires=${expires}; path=/`;
                document.cookie = `mobius_username=${user.username}; expires=${expires}; path=/`;
                window.location.href = '/';
            } catch (err) {
                document.getElementById('error').textContent = 'Fingerprint not recognised. Please log in with password.';
            }
        }

        // ‚îÄ‚îÄ Show fingerprint button if registered ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (window.PublicKeyCredential && localStorage.getItem('mobius_passkey')) {
            document.getElementById('fingerprintBtn').style.display = 'block';
        }
    </script>
</body>
</html>