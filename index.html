<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Mobius</title>
    <link rel="icon" type="image/png" href="mobius-logo.png">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8d7c64">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Mobius">
    <style>
        body {
            font-family: 'Century Gothic', 'Avenir', 'Segoe UI', 'Verdana', sans-serif;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
            background: #e2dccd;
        }
        textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 1px;
            box-sizing: border-box;
            font-family: 'Century Gothic', 'Avenir', 'Segoe UI', 'Verdana', sans-serif;
            resize: vertical;
            min-height: 60px;
            background: #f5eedd;
        }
        .controls {
            display: flex;
            gap: 2px;
            margin-top: 4px;
            align-items: center;
            height: 31px;
        }
        button {
            padding: 2px 10px;
            height: 32px;
            font-size: 16px;
            background: #8d7c64;
            color: white;
            border: none;
            border-radius: 1px;
            cursor: pointer;
        }
        button:hover { background: #574d3e; }
        button:disabled { background: #b8a898; cursor: not-allowed; }

        /* + upload button */
        #uploadBtn {
            width: 31px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            flex-shrink: 0;
            margin-right: 7px;
        }
        #uploadBtn svg { width: 35px; height: 35px; display: block; }
        #uploadBtn:hover svg rect { fill: #574d3e; }

        /* Ask button */
        #askBtn {
            width: 54px;
            background: #8d7c64;
            color: #f5eedd;
            border: none;
            border-radius: 1px;
            font-family: inherit;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            margin-right: 7px;
        }
        #askBtn:hover { background: #574d3e; }

        /* File chips */
        #fileChips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .file-chip {
            background: #d4c9b5;
            border: 1px solid #8d7c64;
            border-radius: 2px;
            padding: 2px 8px;
            font-size: 12px;
            color: #3a2e22;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .file-chip-remove { cursor: pointer; color: #8d7c64; font-weight: bold; font-size: 14px; line-height: 1; }
        .file-chip-remove:hover { color: #3a2e22; }

        /* Chat panel */
        #chatPanel {
            margin-top: 16px;
            margin-bottom: 60px;
            padding: 16px;
            background: #e2dccd;
            border-radius: 1px;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }
        .chat-entry { margin-bottom: 4px; }
        .chat-query { color: #4a3728; font-weight: bold; margin-bottom: 4px; white-space: pre-wrap; }
        .chat-answer { color: #2a2a2a; white-space: pre-wrap; }
        .chat-answer h1, .chat-answer h2, .chat-answer h3 { margin: 4px 0; }
        .chat-answer table { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 13px; display: block; overflow-x: auto; }
        .chat-answer th { background: #8d7c64; color: white; padding: 6px 10px; text-align: left; }
        .chat-answer td { border: 1px solid #c9bfae; padding: 5px 10px; }
        .chat-answer tr:nth-child(even) { background: #ede5d4; }
        .chat-label { font-size: 13px; color: #8d7c64; margin-bottom: 2px; }
        .chat-divider { border: none; border-top: 1px solid #c9bfae; margin: 12px 0; }
        .thinking { color: #8d7c64; font-style: italic; }

        /* Mobius query preview */
        .mq-block {
            background: #ede5d4;
            border: 1px dashed #8d7c64;
            border-radius: 1px;
            padding: 10px 14px;
            font-size: 13px;
            font-family: 'Century Gothic', 'Avenir', 'Segoe UI', 'Verdana', sans-serif;
            white-space: pre-wrap;
            color: #3a2e22;
            margin-top: 6px;
        }
        .mq-label { font-size: 12px; color: #a08060; margin-bottom: 4px; font-family: inherit; }

        /* Chat history list */
        .chat-history-list { margin-top: 2px; }
        .chat-history-item {
            padding: 8px 10px;
            background: #ede5d4;
            border: 1px solid #c9bfae;
            border-radius: 1px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.15s;
            user-select: none;
        }
        .chat-history-item:hover { background: #d9cfbc; }
        .chi-title { font-weight: bold; color: #3a2e22; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chi-meta { font-size: 11px; color: #8d7c64; margin-top: 2px; }

        /* Context menu */
        #contextMenu {
            position: fixed;
            background: #f5eedd;
            border: 1px solid #8d7c64;
            border-radius: 2px;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 180px;
            display: none;
        }
        .ctx-item { padding: 8px 14px; font-size: 14px; color: #3a2e22; cursor: pointer; font-family: inherit; }
        .ctx-item:hover { background: #d9cfbc; }

        /* Image thumbnails */
        .img-thumb { max-width: 100%; max-height: 180px; border: 1px solid #c9bfae; margin-top: 6px; border-radius: 1px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div style="display:flex; align-items:center; gap:15px; margin-bottom:1px;">
        <img src="mobius-logo.png" alt="Mobius Logo" style="height:60px;">
        <h1 style="margin:0; font-size:25px;">Mobius</h1>
        <span id="userLabel" style="margin-left:auto; font-size:14px; color:#4a3728;"></span>
        <a href="/help" target="_blank" style="font-size:13px; color:#8d7c64; text-decoration:none; border:1px solid #8d7c64; padding:2px 8px; border-radius:1px;">Help</a>
    </div>

    <textarea id="input" placeholder="Ask something..." rows="3"></textarea>
    <div id="fileChips"></div>

    <!-- Toolbar -->
    <div class="controls">
        <button id="uploadBtn" title="Attach file" onclick="document.getElementById('fileInput').click()">
            <svg viewBox="0 0 26 26" fill="#8d7c64" xmlns="http://www.w3.org/2000/svg">
                <rect x="9.5" y="2" width="7" height="22"/>
                <rect x="2" y="9.5" width="22" height="7"/>
            </svg>
        </button>
        <input type="file" id="fileInput" style="display:none" multiple accept="image/*,.pdf,.txt,.md,.csv,.js,.py,.html,.json" onchange="handleFileSelect(this)">
        <button id="askBtn" onclick="handleAsk()">Ask</button>
        <div style="display:flex; gap:1px; align-items:center; height:31px; flex-shrink:0; margin-right:7px;">
            <button onclick="navigateChat(-1)" title="Previous query" style="width:30px; height:38px; background:transparent; border:none; cursor:pointer; padding:0; display:flex; align-items:center; justify-content:center;">
                <svg width="30" height="38" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><polygon points="10,0 20,20 0,20" fill="#8d7c64"/></svg>
            </button>
            <button onclick="navigateChat(1)" title="Next query" style="width:30px; height:38px; background:transparent; border:none; cursor:pointer; padding:0; display:flex; align-items:center; justify-content:center;">
                <svg width="30" height="38" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><polygon points="10,20 20,0 0,0" fill="#8d7c64"/></svg>
            </button>
        </div>
        <input id="chatSearch" type="text" placeholder="Search..." oninput="searchChat(this.value)"
            style="height:31px; padding:0 8px; font-size:14px; border:1px solid #8d7c64; background:#f5eedd; color:#4a3728; border-radius:1px; flex:1; min-width:0; box-sizing:border-box;">
    </div>

    <div id="chatPanel"></div>

    <!-- Context menu -->
    <div id="contextMenu">
        <div class="ctx-item" onclick="ctxAction('load')">ðŸ“‚ Open chat</div>
        <div class="ctx-item" onclick="ctxAction('copy-summary')">ðŸ“‹ Copy summary</div>
        <div class="ctx-item" onclick="ctxAction('copy-full')">ðŸ“„ Copy full chat</div>
        <div class="ctx-item" onclick="ctxAction('copy-context')">ðŸ’¬ Copy as context</div>
    </div>

    <script>
        // â”€â”€ Auth helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }
        function getAuth(key) {
            return localStorage.getItem(key) || sessionStorage.getItem(key) || getCookie(key) || null;
        }
        function setAuth(key, value) {
            try { localStorage.setItem(key, value); } catch(e) {}
            try { sessionStorage.setItem(key, value); } catch(e) {}
        }

        // Restore session from cookie/sessionStorage if localStorage was cleared (mobile PWA)
        if (!localStorage.getItem('mobius_user_id')) {
            const id = getCookie('mobius_user_id') || sessionStorage.getItem('mobius_user_id');
            const un = getCookie('mobius_username') || sessionStorage.getItem('mobius_username');
            if (id) { setAuth('mobius_user_id', id); setAuth('mobius_username', un); }
        }
        if (!getAuth('mobius_user_id')) {
            window.location.href = '/login';
        } else {
            document.getElementById('userLabel').textContent = 'User: ' + getAuth('mobius_username');
        }

        // â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('input');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
            textarea.addEventListener('keydown', e => {
                if (e.key === 'Enter' && e.ctrlKey) handleAsk();
            });
        });
        document.addEventListener('click', () => hideContextMenu());

        // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let chatHistory      = [];   // in-session message history sent to AI
        let pendingMobiusQuery = null;
        let attachedFiles    = [];
        let ctxSession       = null;
        let currentNavIndex  = -1;

        const modelLabels = {
            groq: 'Groq', gemini: 'Gemini', mistral: 'Mistral',
            websearch: 'Groq+Tavily', system: 'System'
        };

        // â”€â”€ Environment context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let mobiusContext = null;
        buildContextPayload().then(ctx => { mobiusContext = formatContextForPrompt(ctx); });

        async function buildContextPayload() {
            const ctx = {};
            const now = new Date();
            ctx.datetime   = now.toLocaleString('en-AU', { hour12: false });
            ctx.timezone   = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const off = -now.getTimezoneOffset();
            const sign = off >= 0 ? '+' : '-';
            ctx.utc_offset = `UTC${sign}${String(Math.floor(Math.abs(off)/60)).padStart(2,'0')}:${String(Math.abs(off)%60).padStart(2,'0')}`;
            ctx.locale     = navigator.language || 'unknown';
            const ua = navigator.userAgent;
            ctx.os =
                /Windows NT 10/.test(ua)   ? 'Windows 10/11' :
                /Mac OS X/.test(ua)        ? 'macOS ' + (ua.match(/Mac OS X ([\d_]+)/)?.[1]?.replace(/_/g,'.') || '') :
                /Android/.test(ua)         ? 'Android ' + (ua.match(/Android ([\d.]+)/)?.[1] || '') :
                /iPhone|iPad/.test(ua)     ? 'iOS ' + (ua.match(/OS ([\d_]+)/)?.[1]?.replace(/_/g,'.') || '') :
                /Linux/.test(ua)           ? 'Linux' : 'Unknown';
            ctx.browser =
                /Edg\//.test(ua)     ? 'Edge '    + (ua.match(/Edg\/([\d.]+)/)?.[1]     || '') :
                /Chrome\//.test(ua)  ? 'Chrome '  + (ua.match(/Chrome\/([\d.]+)/)?.[1]  || '') :
                /Firefox\//.test(ua) ? 'Firefox ' + (ua.match(/Firefox\/([\d.]+)/)?.[1] || '') :
                /Safari\//.test(ua)  ? 'Safari '  + (ua.match(/Version\/([\d.]+)/)?.[1] || '') : 'Unknown';
            const isMobile = /Mobi|Android|iPhone|iPad/.test(ua);
            const isTablet = /iPad|Tablet/.test(ua) || (isMobile && Math.min(screen.width, screen.height) > 600);
            ctx.device_type = isTablet ? 'tablet' : isMobile ? 'mobile' : 'desktop';
            if (!isMobile) ctx.screen_resolution = `${screen.width}x${screen.height}`;
            ctx.dark_mode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            ctx.online    = navigator.onLine;
            const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (conn) {
                if (conn.type)     ctx.connection_type = conn.type;
                if (conn.downlink) ctx.bandwidth_mbps  = conn.downlink;
                if (conn.rtt)      ctx.latency_ms      = conn.rtt;
            }
            try {
                const geo = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(3000) });
                if (geo.ok) {
                    const g = await geo.json();
                    if (!g.error) {
                        ctx.city = g.city; ctx.region = g.region;
                        ctx.country = g.country_name; ctx.currency = g.currency;
                    }
                }
            } catch { /* unavailable */ }
            Object.keys(ctx).forEach(k => ctx[k] === undefined && delete ctx[k]);
            return ctx;
        }

        function formatContextForPrompt(ctx) {
            if (!ctx || !Object.keys(ctx).length) return '';
            const lines = ['[User Environment]'];
            if (ctx.datetime)          lines.push(`Date/Time: ${ctx.datetime}`);
            if (ctx.timezone)          lines.push(`Timezone: ${ctx.timezone} (${ctx.utc_offset})`);
            if (ctx.locale)            lines.push(`Locale: ${ctx.locale}`);
            if (ctx.city)              lines.push(`Location: ${ctx.city}, ${ctx.region}, ${ctx.country}`);
            if (ctx.currency)          lines.push(`Currency: ${ctx.currency}`);
            if (ctx.os)                lines.push(`OS: ${ctx.os}`);
            if (ctx.browser)           lines.push(`Browser: ${ctx.browser}`);
            if (ctx.device_type)       lines.push(`Device: ${ctx.device_type}`);
            if (ctx.screen_resolution) lines.push(`Screen: ${ctx.screen_resolution}`);
            if (ctx.dark_mode != null) lines.push(`Dark mode: ${ctx.dark_mode}`);
            if (ctx.online != null)    lines.push(`Online: ${ctx.online}`);
            if (ctx.connection_type)   lines.push(`Connection: ${ctx.connection_type}`);
            if (ctx.bandwidth_mbps)    lines.push(`Bandwidth: ${ctx.bandwidth_mbps} Mbps`);
            if (ctx.latency_ms)        lines.push(`Latency: ${ctx.latency_ms} ms`);
            return lines.join('\n');
        }

        // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function scrollToBottom() {
            const p = document.getElementById('chatPanel');
            p.scrollTop = p.scrollHeight;
        }
        function addDivider() {
            const p = document.getElementById('chatPanel');
            if (p.children.length > 0) {
                const hr = document.createElement('hr');
                hr.className = 'chat-divider';
                p.appendChild(hr);
            }
        }
        function escapeHtml(t) {
            return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }
        function markdownToHtml(text) {
            text = text.replace(/\|(.+)\|\n\|[-| :]+\|\n((?:\|.+\|\n?)+)/g, (match, header, rows) => {
                const ths = header.split('|').filter(s=>s.trim()).map(s=>`<th>${s.trim()}</th>`).join('');
                const trs = rows.trim().split('\n').map(row => {
                    const tds = row.split('|').filter(s=>s.trim()).map(s=>`<td>${s.trim()}</td>`).join('');
                    return `<tr>${tds}</tr>`;
                }).join('');
                return `<table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;
            });
            return text
                .replace(/### (.*$)/gim,'<h3>$1</h3>')
                .replace(/## (.*$)/gim,'<h2>$1</h2>')
                .replace(/# (.*$)/gim,'<h1>$1</h1>')
                .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
                .replace(/\*(.+?)\*/g,'<em>$1</em>')
                .replace(/```([^`]+)```/g,'<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g,'<code>$1</code>')
                .replace(/\n/g,'<br>');
        }
        function formatMobiusQuery(mq) {
            return JSON.stringify({
                ASK: mq.ASK,
                INSTRUCTIONS: mq.INSTRUCTIONS.length ? `[${mq.INSTRUCTIONS.length} message(s)]` : '[]',
                QUERY: mq.QUERY,
                FILES: mq.FILES.length ? mq.FILES.map(f=>f.name) : [],
                CONTEXT: mq.CONTEXT || ''
            }, null, 2);
        }

        // â”€â”€ File handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function handleFileSelect(input) {
            for (const file of Array.from(input.files)) {
                const fd = new FormData();
                fd.append('file', file);
                try {
                    const res  = await fetch('/upload', { method:'POST', body:fd });
                    const data = await res.json();
                    if (data.error) { alert('Upload error: ' + data.error); continue; }
                    attachedFiles.push(data);
                    addFileChip(data);
                } catch (err) { alert('Upload failed: ' + err.message); }
            }
            input.value = '';
        }
        function addFileChip(f) {
            const chips = document.getElementById('fileChips');
            const chip  = document.createElement('div');
            chip.className = 'file-chip';
            chip.dataset.name = f.name;
            chip.innerHTML = `<span>${escapeHtml(f.name)}</span><span class="file-chip-remove" onclick="removeFile('${escapeHtml(f.name)}',this)">âœ•</span>`;
            chips.appendChild(chip);
        }
        function removeFile(name, el) {
            attachedFiles = attachedFiles.filter(f => f.name !== name);
            el.closest('.file-chip').remove();
        }

        // â”€â”€ Context menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showContextMenu(e, session) {
            e.preventDefault();
            ctxSession = session;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top  = e.clientY + 'px';
        }
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }
        async function ctxAction(action) {
            hideContextMenu();
            if (!ctxSession) return;
            if (action === 'load') {
                loadSessionIntoChat(ctxSession);
            } else if (action === 'copy-summary') {
                navigator.clipboard.writeText(buildSummary(ctxSession)).then(() => alert('Summary copied!'));
            } else if (action === 'copy-full') {
                navigator.clipboard.writeText(buildFullText(ctxSession)).then(() => alert('Full chat copied!'));
            } else if (action === 'copy-context') {
                const summary  = buildSummary(ctxSession);
                const filename = 'context-' + new Date(ctxSession.started_at).toISOString().slice(0,10) + '.txt';
                const fd = new FormData();
                fd.append('file', new File([summary], filename, { type:'text/plain' }));
                try {
                    const res  = await fetch('/upload', { method:'POST', body:fd });
                    const data = await res.json();
                    if (data.error) { alert('Error: ' + data.error); return; }
                    attachedFiles.push(data);
                    addFileChip(data);
                } catch (err) { alert('Failed to attach context: ' + err.message); }
            }
        }
        function buildSummary(s) {
            let t = `Chat from ${new Date(s.started_at).toLocaleString()}\nTopic: ${s.title}\n\n`;
            s.messages.slice(0,3).forEach(m => t += `Q: ${m.question}\nA: ${m.answer}\n\n`);
            if (s.messages.length > 3) t += `[...${s.messages.length - 3} more exchanges]`;
            return t.trim();
        }
        function buildFullText(s) {
            let t = `Chat from ${new Date(s.started_at).toLocaleString()}\n${'â”€'.repeat(40)}\n\n`;
            s.messages.forEach(m => t += `Q: ${m.question}\nA: ${m.answer}\n\n`);
            return t.trim();
        }
        function loadSessionIntoChat(session) {
            const panel = document.getElementById('chatPanel');
            panel.innerHTML = '';
            chatHistory = [];
            const header = document.createElement('div');
            header.style.cssText = 'font-size:12px;color:#8d7c64;margin-bottom:12px;font-style:italic;';
            header.textContent = `ðŸ“‚ Loaded chat from ${new Date(session.started_at).toLocaleString()}`;
            panel.appendChild(header);
            for (const m of session.messages) {
                addDivider();
                const entry = document.createElement('div');
                entry.className = 'chat-entry';
                entry.innerHTML = `
                    <div class="chat-query">Q: ${escapeHtml(m.question)}</div>
                    <div class="chat-label">A:(${escapeHtml(modelLabels[m.model] || m.model)})</div>
                    <div class="chat-answer">${markdownToHtml(m.answer)}</div>`;
                panel.appendChild(entry);
                chatHistory.push({ role:'user', content:m.question });
                chatHistory.push({ role:'assistant', content:m.answer });
            }
            scrollToBottom();
        }

        // â”€â”€ Chat history renderer (exposed to commands.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.renderChatHistoryList = function(sessions) {
            const panel = document.getElementById('chatPanel');
            addDivider();
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `<div class="chat-label" style="margin-bottom:8px;">ðŸ“‹ Chat History (${sessions.length} sessions) â€” click to open, right-click for options</div>`;
            const list = document.createElement('div');
            list.className = 'chat-history-list';
            for (const session of sessions) {
                const item  = document.createElement('div');
                item.className = 'chat-history-item';
                const count = session.messages.length;
                item.innerHTML = `
                    <div class="chi-title">${escapeHtml(session.title)}</div>
                    <div class="chi-meta">${new Date(session.started_at).toLocaleString()} Â· ${count} exchange${count!==1?'s':''}</div>`;
                item.addEventListener('click', () => loadSessionIntoChat(session));
                item.addEventListener('contextmenu', e => showContextMenu(e, session));
                list.appendChild(item);
            }
            wrapper.appendChild(list);
            panel.appendChild(wrapper);
            scrollToBottom();
        };

        // â”€â”€ Command output helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function runCommandInPanel(text, command, args) {
            const panel = document.getElementById('chatPanel');
            addDivider();
            const entry = document.createElement('div');
            entry.className = 'chat-entry';
            entry.innerHTML = `<div class="chat-query">Q: ${escapeHtml(text)}</div>`;
            const output = document.createElement('div');
            output.className = 'mq-block';
            output.textContent = 'Running...';
            entry.appendChild(output);
            panel.appendChild(entry);
            scrollToBottom();
            const outputFn = msg => { output.textContent = msg; scrollToBottom(); };
            return { outputFn, outputEl: output };
        }

        // â”€â”€ Main Ask handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function handleAsk() {
            const userId = getAuth('mobius_user_id');
            if (!userId) { window.location.href = '/login'; return; }

            const text = document.getElementById('input').value.trim();
            if (!text && !pendingMobiusQuery) return;

            // â”€â”€ Step 1: Intercept all non-AI commands immediately â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Access: needs special handling (synchronous user gesture for mobile)
            const detected = detectCommand(text);
            if (detected && detected.command === 'access') {
                const { outputFn } = runCommandInPanel(text, 'access', '');
                await handleAccess(outputFn);
                return;
            }
            // All other non-AI commands
            if (detected && detected.command !== 'ask') {
                const { outputFn, outputEl } = runCommandInPanel(text, detected.command, detected.args);
                await runCommand(detected.command, detected.args, outputFn, outputEl);
                return;
            }

            // â”€â”€ Step 2: Pending query confirmation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (pendingMobiusQuery) {
                await executeQuery(userId);
                return;
            }

            // â”€â”€ Step 3: Build query via /parse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            await parseQuery(userId);
        }

        async function parseQuery(userId) {
            const text      = document.getElementById('input').value.trim();
            if (!text) return;
            const model     = getAskModel(text) || 'groq';
            const cleanText = text.replace(/^Ask:\s*\w+[.,]?\s*/i, '').trim() || text;
            const panel     = document.getElementById('chatPanel');

            addDivider();
            const entry = document.createElement('div');
            entry.className = 'chat-entry';
            entry.innerHTML = `
                <div class="chat-query">Q: ${escapeHtml(text)}</div>
                <div class="mq-label">â–¸ Mobius Query (press Ask to send)</div>`;
            const mqPreview = document.createElement('div');
            mqPreview.className = 'mq-block';
            mqPreview.textContent = 'Building...';
            entry.appendChild(mqPreview);

            // Show image previews
            for (const f of attachedFiles) {
                if (f.mimeType?.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'img-thumb';
                    img.src = `data:${f.mimeType};base64,${f.base64}`;
                    entry.appendChild(img);
                }
            }
            panel.appendChild(entry);
            scrollToBottom();

            try {
                const res  = await fetch('/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text:cleanText, model, history:chatHistory, context:mobiusContext })
                });
                const data = await res.json();
                pendingMobiusQuery = data.mobius_query;
                pendingMobiusQuery.FILES = [...attachedFiles];
                // Attach focused file content if active
                if (window.getFocusFile && window.getFocusFile()) {
                    const ff = window.getFocusFile();
                    const focusAttachment = {
                        name: ff.name,
                        mimeType: 'text/plain',
                        base64: btoa(unescape(encodeURIComponent(ff.content || ''))),
                        size: ff.content ? ff.content.length : 0
                    };
                    pendingMobiusQuery.FILES.unshift(focusAttachment);
                }
                if (attachedFiles.some(f => f.mimeType?.startsWith('image/'))) {
                    pendingMobiusQuery.ASK = 'gemini';
                }
                mqPreview.textContent = formatMobiusQuery(pendingMobiusQuery);
                scrollToBottom();
            } catch (err) {
                mqPreview.textContent = 'Error: ' + err.message;
                pendingMobiusQuery = null;
            }
        }

        async function executeQuery(userId) {
            const panel = document.getElementById('chatPanel');
            const mq    = pendingMobiusQuery;
            pendingMobiusQuery = null;
            attachedFiles = [];
            document.getElementById('fileChips').innerHTML = '';

            const modelLabel  = modelLabels[mq.ASK] || mq.ASK;
            const answerLabel = document.createElement('div');
            answerLabel.className = 'chat-label';
            answerLabel.textContent = `A:(${modelLabel})`;
            const answerDiv = document.createElement('div');
            answerDiv.className = 'chat-answer thinking';
            answerDiv.textContent = 'Thinking...';
            const wrapper = document.createElement('div');
            wrapper.appendChild(answerLabel);
            wrapper.appendChild(answerDiv);
            panel.appendChild(wrapper);
            scrollToBottom();

            try {
                const res  = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mobius_query:mq, userId })
                });
                const data = await res.json();
                const reply     = data.reply || data.error;
                const usedModel = data.modelUsed || mq.ASK;
                answerDiv.className = 'chat-answer';
                answerDiv.innerHTML = markdownToHtml(reply);
                answerLabel.textContent = `A:(${modelLabels[usedModel] || usedModel})`;
                chatHistory.push({ role:'user', content:mq.QUERY });
                chatHistory.push({ role:'assistant', content:reply });
                document.getElementById('input').value = '';
                scrollToBottom();
            } catch (err) {
                answerDiv.className = 'chat-answer';
                answerDiv.textContent = 'Error: ' + err.message;
            }
        }

        // â”€â”€ Navigation & search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getQueryEntries() { return Array.from(document.querySelectorAll('.chat-query')); }
        function navigateChat(dir) {
            const entries = getQueryEntries();
            if (!entries.length) return;
            currentNavIndex = Math.max(0, Math.min(entries.length-1, currentNavIndex+dir));
            entries[currentNavIndex].scrollIntoView({ behavior:'smooth', block:'start' });
        }
        function searchChat(term) {
            const panel = document.getElementById('chatPanel');
            panel.querySelectorAll('mark').forEach(m => m.replaceWith(document.createTextNode(m.textContent)));
            panel.normalize();
            if (!term.trim()) return;
            const walker = document.createTreeWalker(panel, NodeFilter.SHOW_TEXT);
            const matches = [];
            let node;
            while (node = walker.nextNode()) {
                if (node.textContent.toLowerCase().includes(term.toLowerCase())) matches.push(node);
            }
            matches.forEach(node => {
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
                const span  = document.createElement('span');
                span.innerHTML = node.textContent.replace(regex, '<mark style="background:#c8b89a;color:#2a2a2a;">$1</mark>');
                node.replaceWith(span);
            });
            const first = panel.querySelector('mark');
            if (first) first.scrollIntoView({ behavior:'smooth', block:'center' });
        }

        // â”€â”€ Google auto-connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function autoConnectGoogle() {
            const userId = getAuth('mobius_user_id');
            if (!userId) return;
            try {
                const res  = await fetch('/auth/google/status?userId=' + userId);
                const data = await res.json();
                if (!data.connected) window.location.href = '/auth/google?userId=' + userId;
            } catch(e) {}
        }
        autoConnectGoogle();
        if (window.location.search.includes('google=connected')) history.replaceState({}, '', '/');
    </script>

    <script src="commands.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js');
        }
    </script>
</body>
</html>